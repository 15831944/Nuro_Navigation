#include "libDrawMap.h"#include "NuroClasses.h"#include "DrawBlock.h"#include "RoadName.h"#include "PoiName.h"#include "CCDCtrl.h"#include "FileMapBaseZ.h"#include "DrawMdwZ.h"#include "DrawMgrZ.h"#include "DrawBglZ.h"#include "DrawSeaZ.h"#include "DrawKilometerDL.h"//added by danile 20121205//#define DRAW_DEBUG#include "Set3DModelPos.h"#define MAJOR_POI_NEW#ifndef MAJOR_POI_NEW#include "DrawMpoiZ.h"#else#include "DrawMajorPoiZK.h"#endif#ifdef NURO_USE_LOGFILE#include "LogFileCtrlZ.h"#endif#ifdef NURO_OS_WINDOWS#define _USE_OPENGLES#endif#ifdef _USE_OPENGLES#include "Draw3DModelZK.h"class CDraw3DModelZK		g_draw3DMdlZK;static  nuBOOL              g_bDrw3DModels = nuFALSE;#endifclass CDrawBlock*			g_pDrawBlock = NULL;class CRoadName*			g_pRoadName	= NULL;class CPoiName*				g_pPoiName	= NULL;//class CPoiName*				g_pPoiZoom	= NULL;//class CCCDCtrl*				g_pCcdCtrl	= NULL;//class CReadBsd*				g_pReadBsd	= NULL;class CDrawMdwZ*			g_pDrawMdwZ	= NULL;class CDrawMgrZ*			g_pDrawMgrZ = NULL;class CDrawBglZ*			g_pDrawBglZ = NULL;class CDrawSeaZ*			g_pDrawSeaZ = NULL;class CDrawKilometerDL*		g_pDrawKilometerDL = NULL;//added by danile 20121205#ifndef MAJOR_POI_NEWclass CDrawMpoiZ*			g_pDrawMpoiZ = NULL;#elseclass CDrawMajorPoiZK*		g_pDrawMajorPoiZK	= NULL;#endifPGDIAPI         g_pDMLibGDI = NULL;PMEMMGRAPI      g_pDMLibMM = NULL;PFILESYSAPI     g_pDMLibFS = NULL;PMATHTOOLAPI    g_pDMLibMT = NULL;//PINNAVIAPI		g_pDMLibIN = NULL;PGLOBALENGINEDATA   g_pDMGdata = NULL;PMAPCONFIG          g_pDMMapCfg = NULL;#define DRAW_STEP_NODRAW			0x00#define DRAW_STEP_BMP1				0x01#define DRAW_STEP_BMP2				0x02#define DRAW_STEP_DRAWINFO			0x04#define DRAW_STEP_SHOWMAP			0x08nuBYTE			g_nDrawStep = DRAW_STEP_NODRAW;nuBYTE			g_bDrawLineToTarget = 0;nuLONG			g_lUseGYRODebug = 0;/*Dll entry. platform dependent*/#ifdef _USRDLL/*nuBOOL nuAPIENTRY NURO_DLLMAIN(	nuHANDLE hModule,                                nuDWORD  ul_reason_for_call,                                nuPVOID lpReserved                               ){    switch (ul_reason_for_call)    {    case NURO_DLL_PROCESS_ATTACH:        break;    case NURO_DLL_THREAD_ATTACH:        break;    case NURO_DLL_THREAD_DETACH:        break;    case NURO_DLL_PROCESS_DETACH:        LibDM_FreeDrawMap();        break;    }    return TRUE;}*/#endif/* Drawmap's Api functions */DRAWMAP_API nuBOOL LibDM_InitDrawMap(PAPISTRUCTADDR pApiAddr, CGApiOpenResource* pRsApi){    g_pDrawBlock = new CDrawBlock();    if( g_pDrawBlock == NULL )    {        return nuFALSE;    }    /*    g_pCcdCtrl = new CCCDCtrl();    if( g_pCcdCtrl == NULL )    {    return nuFALSE;    }    */    g_pRoadName = new CRoadName();    if( g_pRoadName == NULL )    {        return nuFALSE;    }    g_pPoiName = new CPoiName();    if( g_pPoiName == NULL )    {        return nuFALSE;    }    /*    g_pPoiZoom	= new CPoiName();    if( g_pPoiName == NULL )    {    return nuFALSE;    }    g_pReadBsd	= new CReadBsd();    if( g_pPoiName == NULL )    {    return nuFALSE;    }    */        g_pDrawMdwZ = new CDrawMdwZ();    if( !g_pDrawMdwZ )    {        return nuFALSE;    }    g_pDrawMgrZ = new CDrawMgrZ();    if( g_pDrawMgrZ == NULL )    {        return nuFALSE;    }    g_pDrawBglZ = new CDrawBglZ();    if( g_pDrawBglZ == NULL )    {        return nuFALSE;    }    g_pDrawSeaZ = new CDrawSeaZ();    if( g_pDrawSeaZ == NULL )    {        return nuFALSE;    }#ifndef MAJOR_POI_NEW    g_pDrawMpoiZ = new CDrawMpoiZ();    if( g_pDrawMpoiZ == NULL )    {        return nuFALSE;    }#else    g_pDrawMajorPoiZK = new CDrawMajorPoiZK();    if( NULL == g_pDrawMajorPoiZK )    {        return nuFALSE;    }#endif	/*g_pDrawKilometerDL = new CDrawKilometerDL;	if(g_pDrawKilometerDL == NULL)	{		return nuFALSE;	}*/    //    g_pDMLibMM	= pApiAddr->pMmApi;    g_pDMLibFS	= pApiAddr->pFsApi;    g_pDMLibMT	= pApiAddr->pMtApi;    g_pDMLibGDI = pApiAddr->pGdiApi;    //	g_pDMLibIN = pApiAddr->pInApi;        g_pDMGdata = g_pDMLibFS->pGdata;    g_pDMMapCfg = g_pDMLibFS->pMapCfg;        CFileMapBaseZ::InitData(pApiAddr);    if( g_pDMMapCfg == NULL )    {        return nuFALSE;    }        if( !g_pRoadName->Initialize(g_pDMMapCfg->commonSetting.nMaxRoadNameCount, g_pDMMapCfg->scaleSetting.pRoadSetting) )    {        return nuFALSE;    }        if( !g_pPoiName->Initialize(g_pRoadName, g_pDMMapCfg->scaleSetting.pPoiSetting) )    {        return nuFALSE;    }    /*    if( !g_pPoiZoom->Initialize(NULL, g_pDMMapCfg->zoomSetting.pPoiSetting, MAP_ZOOM) )    {    return nuFALSE;    }    */    if( !g_pDrawBlock->Initialize() )    {        return nuFALSE;    }    /*    if( !g_pCcdCtrl->Initialize() )    {    return nuFALSE;    }    */    /*    if( !g_pReadBsd->Init() )    {    return nuFALSE;    }    */        if( !g_pDrawMdwZ->initialize() )    {        return nuFALSE;    }    if( !g_pDrawMgrZ->Initialize() )    {        return nuFALSE;    }    if( !g_pDrawBglZ->Initialize() )    {        return nuFALSE;    }    if( !g_pDrawSeaZ->Initialize() )    {        return nuFALSE;    }#ifndef MAJOR_POI_NEW    if( !g_pDrawMpoiZ->Initialize() )    {        return nuFALSE;    }#else    if( !g_pDrawMajorPoiZK->Initialize() )    {        return nuFALSE;    }#endif	/*if( g_pDrawKilometerDL != NULL )	{		g_pDrawKilometerDL->Free();		delete g_pDrawKilometerDL;		g_pDrawKilometerDL = NULL;	}*/    //    pApiAddr->pDmApi->DM_LoadMap		= LibDM_LoadMap;    pApiAddr->pDmApi->DM_DrawMapBmp1	= LibDM_DrawMapBmp1;    pApiAddr->pDmApi->DM_DrawMapBmp2	= LibDM_DrawMapBmp2;    pApiAddr->pDmApi->DM_DrawZoomRoad	= LibDM_DrawZoomRoad;    pApiAddr->pDmApi->DM_DrawZoomFake	= LibDM_DrawZoomFake;    pApiAddr->pDmApi->DM_DrawFlag		= LibDM_DrawFlag;    pApiAddr->pDmApi->DM_DrawRawCar		= LibDM_DrawRawCar;    pApiAddr->pDmApi->DM_SeekForRoad	= LibDM_SeekForRoad;    pApiAddr->pDmApi->DM_SeekForPOI		= LibDM_SeekForPOI;    pApiAddr->pDmApi->DM_CarToRoad		= LibDM_CarToRoad;    //	pApiAddr->pDmApi->DM_StartTravel	= LibDM_StartTravel;    //	pApiAddr->pDmApi->DM_PendTravel		= LibDM_PendTravel;    //	pApiAddr->pDmApi->DM_StopTravel		= LibDM_StopTravel;    pApiAddr->pDmApi->DM_DrawMap		= LibDM_DrawMap;    pApiAddr->pDmApi->DM_FreeDataMem	= LibDM_FreeDataMem;    pApiAddr->pDmApi->DM_StartOpenGL	= LibDM_StartOpenGL;	pApiAddr->pDmApi->DM_Reset3DModel   = LibDM_Reset3DModel;	pApiAddr->pDmApi->DM_GetNearKilo    = LibDM_GetNearKilo; //added by daniel 20121205        g_nDrawStep = DRAW_STEP_NODRAW;        nuLONG nTmp = 0;    if( !nuReadConfigValue("LINETOTARGET", &nTmp) )    {        nTmp = 0;    }    g_bDrawLineToTarget = (nuBYTE)nTmp;    	if(!nuReadConfigValue("GYRODEBUG", &g_lUseGYRODebug))	{		g_lUseGYRODebug = 0;	}#ifdef _USE_OPENGLES    g_draw3DMdlZK.Inialize(g_pDMGdata->pTsPath, pRsApi, g_pDMLibMT);#endif    return nuTRUE;}DRAWMAP_API nuVOID LibDM_FreeDrawMap(){#ifndef MAJOR_POI_NEW    if( g_pDrawMpoiZ != NULL )    {        g_pDrawMpoiZ->Free();        delete g_pDrawMpoiZ;        g_pDrawMpoiZ = NULL;    }#else    if( NULL != g_pDrawMajorPoiZK )    {        g_pDrawMajorPoiZK->Free();        delete g_pDrawMajorPoiZK;        g_pDrawMajorPoiZK = NULL;    }#endif    if( g_pDrawSeaZ != NULL )    {        g_pDrawSeaZ->Free();        delete g_pDrawSeaZ;        g_pDrawSeaZ = NULL;    }    if( g_pDrawBglZ != NULL )    {        g_pDrawBglZ->Free();        delete g_pDrawBglZ;        g_pDrawBglZ = NULL;    }    if( g_pDrawMgrZ != NULL )    {        g_pDrawMgrZ->Free();        delete g_pDrawMgrZ;        g_pDrawMgrZ = NULL;    }    if( g_pDrawMdwZ != NULL )    {        g_pDrawMdwZ->free();        delete g_pDrawMdwZ;        g_pDrawMdwZ	= NULL;    }        /*    if( g_pReadBsd != NULL )    {    g_pReadBsd->Free();    delete g_pReadBsd;    g_pReadBsd = NULL;    }          if( g_pCcdCtrl != NULL )      {      g_pCcdCtrl->Free();      delete g_pCcdCtrl;      g_pCcdCtrl = NULL;}*/    if( g_pDrawBlock != NULL )    {        g_pDrawBlock->Free();        delete g_pDrawBlock;        g_pDrawBlock = NULL;    }    /*    if( g_pPoiZoom != NULL )    {    g_pPoiZoom->Free();    delete g_pPoiZoom;    g_pPoiZoom = NULL;    }    */    if( g_pPoiName != NULL )    {        g_pPoiName->Free();        delete g_pPoiName;        g_pPoiName = NULL;    }    if( g_pRoadName != NULL )    {        g_pRoadName->Free();        delete g_pRoadName;        g_pRoadName = NULL;    }}DRAWMAP_API nuBOOL LibDM_LoadMap(nuPVOID pVoid){    PACTIONSTATE pAcSt = (PACTIONSTATE)pVoid;    g_pDrawMgrZ->AllocDrawMem();    #ifdef _USE_SEA_DRAW    g_pDrawSeaZ->LoadData( g_pDMLibFS->pGdata->transfData.nuShowMapSize,         g_pDMMapCfg->scaleSetting.scaleTitle.nScale);#endif    #ifndef MAJOR_POI_NEW    g_pDrawMpoiZ->ReadMpoiData();#else    g_pDrawMajorPoiZK->ReadMajorPoi();#endif    if( g_pDMGdata->uiSetData.nBsdDrawMap )    {        if( g_pDMGdata->uiSetData.nBsdDrawMap == BSD_MODE_5k )        {#ifdef _USE_BGL_DRAW            g_pDrawBglZ->FreeData();#endif        }        else        {#ifdef _USE_BGL_DRAW            g_pDrawBglZ->LoadData( g_pDMLibFS->pGdata->transfData.nuShowMapSize,                g_pDMMapCfg->scaleSetting.scaleTitle.nScale);#endif	        }    }    else    {#ifdef _USE_BGL_DRAW        g_pDrawBglZ->FreeData();#endif    }    if( pAcSt->bLoad2kBlock )    {    /*    if( !pAcSt->bNeedExtendRotate &&    (pAcSt->nDrawMode == DRAWMODE_GPS || pAcSt->nDrawMode == DRAWMODE_SIM) &&     (g_pDMLibFS->pUserCfg->nVoiceControl & VOICE_CONTROL_CCD) )    {    g_pCcdCtrl->LoadCCDData();//